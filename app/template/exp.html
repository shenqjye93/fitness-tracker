<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elo Tracker</title>
    <style>
    
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
    }

    .scrollable-container {
        height: 200px; /* Set a fixed height or max height */
        overflow-y: auto; /* Enable vertical scrolling */
        overflow-x: hidden; /* Optional: Disable horizontal scrolling */
    }
          
    .container {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        width: 350px;
        text-align: center;
    }
    
    h1 {
        margin-bottom: 20px;
    }
    
    .form {
        display: flex;
        flex-direction: column;
    }
    
    label {
        margin-top: 10px;
    }
    
    input, select {
        padding: 8px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    
    button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    button:hover {
        background-color: #45a049;
    }
    
    #resultContainer {
        margin-top: 20px;
    }
    
    #newElo {
        font-size: 1.5em;
        font-weight: bold;
    }
    
    #history, #leaderboard {
        margin-top: 30px;
        text-align: left;
        border-top: 2px solid #ccc;
        padding-top: 20px;
    }
    
    #eloHistory, #leaderboardList {
        list-style-type: none;
        padding: 0;
    }

    #teamEloContainer {
    margin-top: 20px;
    padding: 20px;
    border-top: 2px solid #ccc;
    text-align: left;
    text-align: center;
    }

    #calculatedTeamElo {
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
    }
    </style>
</head>
<body>

    <div class="container">
        <h1>Elo Tracker</h1>

        <!-- Player Input Form -->
        <div class="form">
            <label for="playerName">Your Name:</label>
            <input type="text" id="playerName" placeholder="Enter your name" required>

            <label for="playerElo">Your Elo:</label>
            <input type="number" id="playerElo" placeholder="Enter your Elo" required>

            <label for="opponentElo">Opponent's Elo:</label>
            <input type="number" id="opponentElo" placeholder="Enter opponent's Elo" required>

            <label for="result">Did you win?</label>
            <select id="result">
                <option value="win">Win</option>
                <option value="lose">Lose</option>
            </select>

            <label for="pulled">Did you pull?</label>
            <select id="pulled">
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>

            <label for="totalGames">Total Games Played:</label>
            <input type="number" id="totalGames" placeholder="Total games played" required>
            
            <div id="teamEloContainer">
                <h2>Calculate Team Elo</h2>
                <label for="player1Elo">Player 1 Elo:</label>
                <input type="number" id="player1Elo" placeholder="Enter Player 1 Elo" required>
            
                <label for="player2Elo">Player 2 Elo:</label>
                <input type="number" id="player2Elo" placeholder="Enter Player 2 Elo" required>
            
                <label for="player3Elo">Player 3 Elo:</label>
                <input type="number" id="player3Elo" placeholder="Enter Player 3 Elo" required>
            
                <button onclick="calculateTeamElo()">Calculate Team Elo</button>
            
                <h2>Team Elo:</h2>
                <p id="calculatedTeamElo">-</p>
            </div>
            <button onclick="calculateElo()">Calculate New Elo</button>
        </div>

        <!-- Elo History and Leaderboard -->
        
        <div id="resultContainer">
            <h2>Your New Elo:</h2>
            <p id="newElo">-</p>
        </div>

        <div class="scrollable-container">
            <div id="history">
                <h2>Elo History:</h2>
                <ul id="eloHistory"></ul>
            </div>
        </div>

        <div class="scrollable-container">
            <div id="leaderboard">
                <h2>Leaderboard:</h2>
                <ul id="leaderboardList"></ul>
            </div>
        </div>
    </div>
    
    <script>
const STARTING_ELO = 400;
const PULL_FACTOR = 0.298701299;
const NormalK = 32;
const UnrankedK = 64;
const D = 400;
const L = 200;
const slope = 0.005;
const midpoint = 850;

// Helper function to calculate expected value
function expectedValue(oldPlayerElo, opponentElo){
    return 1 / (1 + Math.pow(10, (opponentElo - oldPlayerElo) / D));
}

// Function to calculate new Elo
function calculateNewElo(oldPlayerElo, winningTeamElo, losingTeamElo, win_boolean, totalGames, winner_pulled, pull_factor = PULL_FACTOR){
    let k = NormalK;
    if (totalGames < 10) {
        k = UnrankedK;
    }

    let ret = 0
            if (win_boolean){ //win
                if (winner_pulled){ //player won and pulled
                    console.log("brake",k*(1-expectedValue(oldPlayerElo,losingTeamElo, win_boolean, winner_pulled)))
                    console.log("multiplier",1/pull_factor)
                    ret = oldPlayerElo + k*(1-expectedValue(oldPlayerElo,losingTeamElo, win_boolean, winner_pulled)) / pull_factor
                }else{ //player won and received
                    console.log("held",k*(1-expectedValue(oldPlayerElo,losingTeamElo, win_boolean, winner_pulled)))
                    ret = oldPlayerElo + k*(1-expectedValue(oldPlayerElo,losingTeamElo, win_boolean, winner_pulled) / (1/pull_factor))
                }

            }else{ //lost
                const CalculatedLosingTeamElo = calculateTeamElo()
                const player_team_elo = Math.min(oldPlayerElo,CalculatedLosingTeamElo)

                if (winner_pulled){ //player lost and received
                    console.log("other team held",k*(0-expectedValue(player_team_elo,winningTeamElo, win_boolean, winner_pulled)))
                    ret = Math.max(0,oldPlayerElo + k*(0-expectedValue(player_team_elo,winningTeamElo, win_boolean, winner_pulled)) / (1/pull_factor)) 
                    
                }else{ //player lost and pulled
                    console.log("broken",k*(0-expectedValue(player_team_elo,winningTeamElo, win_boolean, winner_pulled)))
                    console.log("multiplier",1/(pull_factor))
                    ret = Math.max(0,oldPlayerElo + k*(0-expectedValue(player_team_elo,winningTeamElo, win_boolean, winner_pulled)) / pull_factor) 
                }
            }
            return ret
}
/**
 * Calculates team Elo. Higher-ranked players get weighted more.
 * @param {Array} team - Array of player Elo values.
 * @returns {float} Team Elo.
 */
 function calculateWeightedTeamElo(team) {
    const teamElo = (weightedRank(team[0]) + weightedRank(team[1]) + weightedRank(team[2])) / 3;
    return teamElo.toFixed(2);
}

/**
 * Logistically weighted Elo.
 * Formula: L / (1 + Math.E ** (-slope * (elo - midpoint)))
 * @param {float} elo - Player's Elo.
 * @returns {float} Weighted Elo.
 */
function weightedRank(elo) {
    return elo + L / (1 + Math.E ** (-slope * (elo - midpoint)));
}

/**
 * Event handler to calculate and display team Elo.
 */
function calculateTeamElo() {
    const player1Elo = parseFloat(document.getElementById('player1Elo').value);
    const player2Elo = parseFloat(document.getElementById('player2Elo').value);
    const player3Elo = parseFloat(document.getElementById('player3Elo').value);

    if (isNaN(player1Elo) || isNaN(player2Elo) || isNaN(player3Elo)) {
        alert('Please enter valid Elo values for all players.');
        return;
    }

    const team = [player1Elo, player2Elo, player3Elo];
    const teamElo = calculateWeightedTeamElo(team);

    document.getElementById('calculatedTeamElo').textContent = teamElo;
    return teamElo;
}
// Function to update Elo history and leaderboard
function updateHistory(playerName, newElo) {
    let history = JSON.parse(localStorage.getItem('eloHistory')) || [];
    history.push({ name: playerName, elo: newElo, date: new Date().toLocaleString() });

    // Save updated history to localStorage
    localStorage.setItem('eloHistory', JSON.stringify(history));

    // Display Elo history
    displayHistory();
}

function updateLeaderboard(playerName, newElo) {
    let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
    leaderboard.push({ name: playerName, elo: newElo });

    // Sort leaderboard by Elo score
    leaderboard.sort((a, b) => b.elo - a.elo);

    // Save updated leaderboard to localStorage
    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));

    // Display leaderboard
    displayLeaderboard();
}

// Display Elo history
function displayHistory() {
    const historyList = document.getElementById('eloHistory');
    const history = JSON.parse(localStorage.getItem('eloHistory')) || [];

    historyList.innerHTML = '';
    history.forEach(entry => {
        const li = document.createElement('li');
        li.textContent = `${entry.name}: ${entry.elo} (on ${entry.date})`;
        historyList.appendChild(li);
    });
}

// Display leaderboard
function displayLeaderboard() {
    const leaderboardList = document.getElementById('leaderboardList');
    const leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];

    leaderboardList.innerHTML = '';
    leaderboard.forEach(entry => {
        const li = document.createElement('li');
        li.textContent = `${entry.name}: ${entry.elo}`;
        leaderboardList.appendChild(li);
    });
}

// Main function to calculate Elo and update history and leaderboard
function calculateElo() {
    const playerName = document.getElementById('playerName').value;
    const playerElo = parseFloat(document.getElementById('playerElo').value);
    const opponentElo = parseFloat(document.getElementById('opponentElo').value);
    const result = document.getElementById('result').value === 'win';
    const pulled = document.getElementById('pulled').value === 'true';
    const totalGames = parseInt(document.getElementById('totalGames').value);

    if (isNaN(playerElo) || isNaN(opponentElo) || isNaN(totalGames)) {
        alert('Please fill out all fields correctly.');
        return;
    }

    const newElo = calculateNewElo(playerElo, opponentElo, opponentElo, result, totalGames, pulled, PULL_FACTOR);

    // Update Elo history and leaderboard
    updateHistory(playerName, newElo);
    updateLeaderboard(playerName, newElo);

    // Display the new Elo
    document.getElementById('newElo').textContent = newElo.toFixed(2);
}

// Initialize the display when the page loads
window.onload = function() {
    displayHistory();
    displayLeaderboard();
};

        </script>
</body>
</html>
